[![ЮKassa](/i/yookassalogo.png "ЮKassa")](https://yookassa.ru) / [помощь](https://yookassa.ru/docs/support) / [api-докуметация](https://yookassa.ru/developers), [Checkout.js](https://yookassa.ru/developers/payment-forms/other/yc-js), [SDK](https://yookassa.ru/developers#sdk)

Return_url. Рекомендации по реализации
======================================

> При [создании платежа](https://yookassa.ru/developers/api#create_payment) в параметре `return_url` вы передаете ссылку, которая будет работать на любом этапе платежа как ссылка [кнопки "вернуться в магазин"](/demo/020-01%20вернуться%20в%20магазин.md). В момент перехода плательщика на вашу страницу `return_url` рекомендуем выполнять [запрос о статусе платежа](https://yookassa.ru/developers/api#get_payment).

### Как понять, от какого платежа пришел конкретный пользователь

Один платеж, один `return_url`. У каждого отдельного платежа, в момент его [создания](https://yookassa.ru/developers/api#get_payment), вы можете передавать уникальный идентификатор. Например, для платежа1, `"return_url": "https://url.test?id=100500"`, а для платежа2, `"return_url": "https://url.test?id=100700"`. Чтобы повысить точность, вы можете проверять cookie вернувшегося. Этим вы обеспечите механизм распознавания, что за пользователь к вам пришел по ссылке `return_url`.

### Не путайте `return_url` и [URL для уведомлений](/checkout-api/031-01%20url%20для%20уведомлений.md)

* `return_url` - это урл, куда переходит плательщик, при нажатии кнопки ["вернуться в магазин"](/demo/020-01%20вернуться%20в%20магазин.md).
* [URL для уведомлений](/checkout-api/031-01%20url%20для%20уведомлений.md) - урл, куда наша система шлет уведомления (POST-запросы), в случае изменений статуса у конкретного платежа. Например, из статуса `panding` (ожидает оплаты) в статус `wating_for_capture` (ожидает подтверждения о приеме оплаты магазином).
* На `return_url` мы не шлем никаких платежных данных (некоторые разработчики имеют предположение, что было бы удобней получать платежные данные и статусы платежа именно на `return_url`). Для получения данных о платеже и статус платежа служит именно [URL для уведомлений](/checkout-api/031-01%20url%20для%20уведомлений.md).

## За и против

"Один `return_url`?", - вполне адекватный вопрос программиста, привыкшего к реализации, когда URL-ы страницы для успеха, ошибки или иного статуса, заранее известны. Ниже на нескольких примерах мы постараемся объяснить, почему в нашем API мы выбрали вариант, когда есть только одна страница `return_url` и почему мы считаем такой вариант наулучшим.

### Пример оплаты методом Сбербанк-онлайн

##### Сценарий1

Плательщик получил смс с номера 900, подтвердил, но на стороне сбербанка в этот момент произошел сбой в компоненте оплаты. Или у мобильного оператора очередь доставки смс. Сам пользователь не нажал кнопку отправки смс или телефон по каким-то причинам не выполнил отправку смс. Факт: платеж не оплачен. На какую страницу должна вести ссылка "Вернуться в магазин" в этот момент времени? Успех? Нет. Ошибки? Нет. Промежуточный статус? Возможно. А если в момент перехода по ссылке "Вернуться в магазин" статус изменился, смс дошла, деньги списались, а вы плательщику покажете "Что-то пошло не так". В общем, довольно сложно сделать 100%-ное попадание.

**Решение1**: После перехода плательщика на страницу `return_url` сделать [запрос о статусе платежа](https://yookassa.ru/developers/api#get_payment), показав иформацию в зависимости от полученного статуса.

| Значение status | Что сообщить покупателю |
| --------------- | ----------------------- |
| `pending`       | Заказ еще не оплачен. Если вы оплатили заказ, обратите внимание, что Сбербанк еще не передал информацию об успехе оплаты. Проверка статуса будет выполнена автоматически через 1 минуту. |
| `canceled`      | Заказ не оплачен. В процессе оплаты произошла ошибка в платежной системе. Средства были возвращены на ваш счет. Если информация об этом не отобразилась в ЛК.Сбербанка или нет смс о возврате средств, пожалуйста, подождите. Возврат средств может занять до трех дней. (Возможно еще какой-либо текст). |
| `succeeded`     | Поздравляем! Заказ оплачен. Средства успешно пришли в наш магазин. Вы можете забрать ваш заказ по адресу: город, улица, офис, схема проезда. Обратите внимание, что вы можете заказать курьерскую доставку (кнопка для заказа), т.к. сумма вашего заказа больше 1000 руб. доставка бесплатная. | 
| `waiting_for_capture` | Мы видим, что вы оплатили заказ. Приносим свои извинения, мы обрабатываем ваш заказ. Если вы готовы подождать, менеджер свяжется с вами и товар будет доставлен через два дня. Либо нажмите здесь и заказ будет анулирован, средства вернутся на ваш счет. | 

##### Сценарий2

Плательщик не получил никакой смс или не понял что ему делать и поэтому просто вернулся обратно на сайт, нажав на кнопку "Вернуться в магазин". Куда он должен попасть?

| Значение status | Что сообщить покупателю |
| --------------- | ----------------------- |
| `pending`       | Заказ еще не оплачен. Вы не получили смс с кодом подтверждения заказа? Пожалуйста, подождите. Как только смс придет, подтвердите заказ. Автоматически мы проверим статус оплаты через минуту. Нажмите *здесь*, если хотите проверить статус оплаты самостоятельно. Если вам не понятно, что нужно сделать, нажмите здесь, с вами свяжется наш специалист.  |

##### Сценарий3

Плательщик все сделал верно, все смс пришли, деньги списались с пользователя. Казалось бы, кнопка "вернуться в магазин" на страницу  успеха самое верное решение. Но оказалось, что пока плательщик платил, выяснилось, что товара нет на складе, не тот цвет или нет нужного количества. Плательщик оплатил и перешел на вашу страницу успеха.

| Значение status | Что сообщить покупателю |
| --------------- | ----------------------- |
| `waiting_for_capture` | **Вариант-1**<br>Мы видим, что вы оплатили заказ. Приносим свои извинения, но с момента начала заказа прошло 2 часа и выяснилось, что товара нет на складе. Если вы готовы подождать, менеджер свяжется с вами и товар будет доставлен через два дня. Либо нажмите здесь и заказ будет анулирован, средства вернутся на ваш счет. | 
| `waiting_for_capture` | **Вариант-2**<br>Мы видим, что вы оплатили заказ на сумму 10'000 руб. К сожалению, выяснилось, что в наличии есть только 9 коробок конфет. Вы можете отменить ваш заказ, либо подтвердить, и тогда будет списано 9 тыс. руб. 1 тыс. руб будет вам возвращена. |

<!--
### Чего не будет

Сценарий, к которому привыкли пользователи нашего старого API и которого теперь не будет. В старом API было три ссылки:
* shopDefaultUrl - ссылка "вернуться в магазин", на странице платежа до момента осуществления оплаты;
* shopSuccessURL - ссылка на странице успеха платежа, после успешной оплаты;
* shopFailURL - ссылка на странице, которая отображается после нажатия кнопки "оплатить" и если оплата была не успешной (не достаточно средств, не пройден 3DS и т.д.)

Теперь только одна ссылка, значение которой передается в `return_url`.
-->
