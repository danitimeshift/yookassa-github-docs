Новое платежное API
===================

> Хотелось бы обратить ваше внимание на то, что кроме варианта реализации  платежей на нашем старом платежном протоколе, есть другой, более удобный и перспективный вариант, в том числе менее дорогостоящий в разработке - это интеграция на нашем новом платежном протоколе. Этот протокол был запущен в октябре 2017 и на нем уже работают порядка 40% наших контрагентов.  
Практика показывает, что интеграция  платежей на старом протоколе требует больше времени, чем если реализовать платежи на новом протоколе. Интеграция на старом протоколе сложнее, как на этапе разработки, так и в дальнейшей поддержке этого режима со стороны контрагента (отсутствие поддержки SNI режима HTTPS, замена сертификатов раз в год, привязка к выделенному IP, нет штатной возможности уточнять статус по платежу, отсутствие мапинга карточных ошибок и т.д.).

### Преимущества

Каковы преимущества нового API vs старый протокол:

1. Привычное REST взаимодействие. Более простая и понятная архитектура, предсказуемость поведения. Старый протокол в этом плане был "белой вороной", где все по своему и реализация не похожа на другие платформы. Каждый отдельный метод платежа - это отдельный, не связанный с предыдущим вариантом синтаксис, сценарий и процесс. По мнению программистов, которые реализовали современные платежные протоколы, наш новый протокол соответствует стандартам, наследует логику известных платежных решений и их сценарии.
2. Возвраты платежей из коробки. Не нужно реализовывать MWS со всеми сложностями, например: обязательная упаковка запросов в PKCS7-пакет, открытие доступов по IP, ежегодная генерация сертификатов и т.п., сложный синтаксис самих запросов. В новом API этих сложностей нет.
3. Холды (платежи картой с предавторизацией средств) из коробки. Тоже не надо ничего дополнительно реализовывать, в новом API холды по-умолчанию.
4. Рекурренты картами проще, без необходимости MWS. Требуется только согласование с СБ как и раньше. При рекурренте картой, требующей 3DS, вместо ошибки, теперь вы получаете ссылку на 3DS, которую отдаете плательщику и он сможет оплатить, введя код из sms. Никакого повторого ввода номера карты.
5. Рекурренты кошельком, а не только картой. Холды на кошелечных платежах.
6. СМС инвойсинг Сбербанка из коробки (с номера 900 приходит код и плательщик выполняет подтверждение отправкой кода по смс). 
7. Возможность запрашивать статус по платежу из коробки. Раньше надо было реализовывать listOrders MWS.
8. На текущий момент четыре вида колбеков (уведомлений контрагента на его урл о событиях о платеже): 1) платеж ожидает подтверждения мерчантом после оплаты: 2) платеж оплачен 3) платеж отменен или произошла ошибка при платеже 4) платеж возвращен. Количество таких колбеков будет больше. Для информационной системы контрагента это важно, чтобы не ходить за статусом каждого, а получать уведомление, если что-то по конкретному платежу изменилось. Рассматриваются планы по уведомления о чаржбек операциях.
9. Мобильный SDK для IOS и Android.
10. SDK для PHP, Python, Node.js
11. Есть поддержка ApplePay и GooglePay в mSDK. Есть поддержка веб-режима для GooglePay (хотя она и для старого протокола поддерживается). В Q1-2019 появится веб-режим для ApplePay. Оба не в режиме iframe.
12. Мапинг ошибок платежа. Теперь, если платеж не прошел, то по API вы получаете информацию о причинах. Например, недостаточно средств на карте, или плательщику не подключен Сбербанк.Онлайн, и т.д.

### Документация

Docs-en:  https://checkout.yandex.com/docs/checkout-api/   
Guides-en: https://checkout.yandex.com/docs/guides/

Docs-ru: https://kassa.yandex.ru/docs/checkout-api/
Guides-ru: https://kassa.yandex.ru/docs/guides/

### Дополнительные рекомендации

1. URL для уведомлений https://goo.gl/EWyjNn
2. Return_url. https://goo.gl/MZGaEk

### Тестовое окружение

Чтобы попробовать новое API https://goo.gl/UTxiRc с помощью REST-клиента Insomnia.
