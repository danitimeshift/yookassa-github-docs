<!-- > [начало интеграции](#Начало-интеграции), [общий план](#Общий-план), [платежная форма](#Шаг-1-Платежная-форма), [обзор](#Шаг-2-Скрипты-checkurl-и-avisourl-колбеки) check aviso, [md5](#Шаг-21-Проверка-md5-суммы-при-ответах-на-запросы-checkorder-и-paymentaviso-документация), [xml-примеры ответов](#Шаг-22-Примеры-ответов-колбеков-checkurl-и-avisourl), [коды ответов](#Коды-ответов), [curl](#Пример-curl-эмулирующий-наш-запрос-на-ваш-checkurl), [тестирование](#Шаг-3-Тестирование) 

* [Пример кода](https://github.com/yandex-money/yandex-money-kassa-example/blob/master/src/YaMoneyCommonHttpProtocol.php#L102) на PHP;

#### Вашему программисту понадобится
* [Пример html-кода простой платежной формы](/demo/021%20пример%20платежной%20формы.html)
* [Описание процесса платежа](/demo/020%20описание%20процесс%20платежа.md)
* [Рекомендации по скриптам взаимодействия (checkURL и avisoURL)](#Шаг-2-Скрипты-checkurl-и-avisourl-колбеки)

Это пошаговая инструкция для самописных сайтов (сделанных НЕ на CMS), либо для тех, кто пишет свой самописный платежный модуль взаимодействия с Яндекс.Кассой. В инструкции вы найдете ответы на вопросы: что нужно сделать, чтобы начать принимать платежи в ваш электронный магазин через платежный сервис Яндекс.Касса (при использовании схемы интеграции HTTP), какие параметры должны передаваться из вашей платежной формы, как технически устроен процесс оплаты, какие нужны скрипты для взаимодействия Яндекс.Кассы с вашим сайтом (ваши скрипты мы называем колбеками) и требования к ним, сценарий тестирования, решение ошибок.

[test]: http://test

[Как переключиться на новый протол или попробовать его в действии](#).
-->

[![яндекс касса](/i/yakassalogo.png "Яндекс Касса")](https://kassa.yandex.ru) / документация / [http](/demo/010%20интеграция%20для%20самописных%20сайтов.md):arrow_left:, [cms](/demo/011%20интеграция%20для%20CMS%20и%20SaaS.md), [email](/010%20интеграция%20email.md), [тестирование](/demo/030%20тестирование.md), [решение ошибок](/demo/031%20решение%20ошибок.md), [демо](/demo/032%20демо%20стенд.md),  [54-ФЗ](/demo/54-fz.md)

Интеграция оплаты в Яндекс.Кассе. Схема: HTTP  
(старый протокол приема платежей)
=============================================


> :mortar_board: Если вы программист и пишите скрипты оплаты через сервис Яндекс.Касса, то эта статья для вас. Обратите внимание! Эта статья про наш старый платежный протокол. Вместо старого платежного протокола, мы рекомендуем вам обратить внимание на новый протокол (действует с октября 2017 года). [Преимущества нового протокола](/012%20новое%20платежное%20API.md). 

> :alien: **Вы не программист? Случайно выбрали не тот способ подключения?**  
Напишите в ответ на письмо нашего техника: мне нужна другая схема подключения, например: email (протокол, когда вы создаете платежную форму и письма об оплате приходят вам на почту) или CMS (протокол, когда у вас сайт сделан на CMS в в админке есть платежный модуль для работы с Яндекс.Кассой). Мы вас быстренько переключим.

### Требования к интеграции по схеме HTTP
- [x] [Зарегистрируйтесь в Яндекс.Кассе](https://money.yandex.ru/joinups/) (доступно только для юридических лиц и ИП).
- [x] Заполните нашу [техническую анкету](https://tech.yandex.ru/money/doc/payment-solution/shop-config/intro-docpage/).
- [ ] Ваш сайт должен поддерживать работу по HTTPS протоколу ([требования](/demo/040%20требования%20к%20HTTPS%20протоколу%20и%20SSL%20сертификату.md));
- [ ] Ваши скрипты checkURL и avisoURL должны [корректно](#Шаг-22-Примеры-ответов-колбеков-checkurl-и-avisourl) отвечать на наши запросы.
- [x] Получите от нас идентификаторы **shopId** и **scid**:

> **shopId** (идентификатор магазина) = **100500**  
> **scid** (номер витрины) = **555777**  
> _это пример идентификаторов из письма; для начала интеграции необходимы **shopId** и **scid**, вы получите их в письме после того, как менеджер Яндекс.Кассы выполнит процесс вашей регистрации_

---

### Общий план
| Краткое описание                                      | Пошаговая инструкция    | Ссылка на документацию |
| ----------------------------------------------------- | ----------------------- | ---------------------- |
| 1. Создайте платежную форму, прописав в ней ваши **shopId** и **scid**. | [Шаг 1. Форма](#Шаг-1-Платежная-форма) | [#url](https://tech.yandex.ru/money/doc/payment-solution/payment-form/payment-form-http-docpage/)
| 2. Создайте скрипты для обработки наших запросов. | [Шаг 2. Колбеки](#Шаг-2-Скрипты-checkurl-и-avisourl-колбеки) | [#url](https://tech.yandex.ru/money/doc/payment-solution/payment-notifications/payment-notifications-http-docpage/) |
| 3. Выполните тестирование оплаты. | [Шаг 3. Тесты](/demo/030%20тестирование.md) |  | 
| 4. После успешной оплаты в демо-режиме, напишите нам и мы переведем вас в боевой режим.| | | 
| 5. Если при тестировании возникнут ошибки и информации на данной странице будет не достаточно, напишите нам. | [Шаг 3.1. Ошибки](/demo/031%20решение%20ошибок.md) | |

### Шаг 1. Платежная форма
Файл "[пример платежной формы.html](/demo/021%20пример%20платежной%20формы.html)" содержит минимальный код, чтобы создать платежную форму, содержащую достаточный минимум полей, которые нужны для начала оплаты через платежную систему Яндекс.Касса. Скопируйте код к себе, отредактируйте, прописав свои значения **shopId** и **scid**. В файле примера это будут следующие строки:

```html
    <input name="shopId" value="впишите-сюда-значение-своего-shopId" type="hidden">
    <input name="scid" value="впишите-сюда-значение-своего-scid-для-демо-режима" type="hidden">
```

В форме оплаты обязательно пропишите обработчик демо среды:
```html
    <form action="https://demomoney.yandex.ru/eshop.xml" method="POST">
```

Вставьте код в html-документ или добавьте на страницу своего сайта. Минимальная платежная форма готова.

Обратите внимание:
* обязательными параметрами платежа являются **shopId**, **scid**, **customerNumber** и **sum**, без них платежи работать не будут (customerNumber - идентификатор плательщика, например, "Покупатель N1"; sum - сумма платежа в рублях);
* если вы хотите передавать больше данных из формы, прочитайте как это сделать в [документации](https://tech.yandex.ru/money/doc/payment-solution/payment-form/payment-form-http-docpage/);
* для демо платежей и платежей в реале, значение shopId одинаковое;
* значение scid для демо будет одно, а для реала другое; если вы пропишите боевой scid для платежей в демо, то платежи в демо работать не будут.

### Шаг 2. Скрипты checkURL и avisoURL (колбеки)

После выполнения шага 1, создайте два скрипта, которые будут отвечать во время платежа на запросы нашей системы (сделать это в одном скрипте тоже можно); скрипты должны быть доступны по https-протоколу: 

* На ваш checkURL мы отправляем POST-запрос, который должен инициировать на вашей стороне (вы это реализуете сами) проверку наличия такого заказа в вашей системе, состав заказа, возможность его выдачи и т.д. ([action=checkOrder](https://tech.yandex.ru/money/doc/payment-solution/payment-notifications/payment-notifications-check-docpage/)). [Пример запроса с помощью CURL](#Пример-curl) см. ниже.
* На ваш avisoURL мы отправляем POST-запрос о том, что ваш покупатель оплатил заказ ([action=paymentAviso](https://tech.yandex.ru/money/doc/payment-solution/payment-notifications/payment-notifications-aviso-docpage/)). Состав данных передаваемых от Яндекс.Кассы такой же, как и на checkURL.
* Подробное [описание процесса платежа](/demo/020%20описание%20процесс%20платежа.md), посмотрите его.
* [PHP-пример кода](https://github.com/yandex-money/yandex-money-kassa-example/blob/master/src/YaMoneyCommonHttpProtocol.php#L102)  скриптов check и avisoURL.

> При регистрации в Яндекс.Кассе вы заполняли техническую анкету, где должны были указать ссылки на ваши скрипты, которые будут обрабатывать наши запросы. У нас они называются checkURL и avisoURL. URL этих скриптов прописаны в настройках вашего shopId. Если в процессе прочтения этой статьи вы поняли, что указали неправильные урлы и нужно их заменить, пришлите правильные урлы вашему менеджеру.

#### Шаг 2.1. Проверка MD5 суммы при ответах на запросы checkOrder и paymentAviso

В своем запросе на ваши checkURL и avisoURL мы передаем следующие параметры:
> action, orderSumAmount, orderSumCurrencyPaycash, orderSumBankPaycash, shopId, **invoiceId**, customerNumber, **MD5**

Значение ([параметров](https://tech.yandex.ru/money/doc/payment-solution/payment-notifications/payment-notifications-check-docpage/)).

Мы передаем все эти параметры на ваши колбеки при каждом платеже, чтобы вы сверили значение MD5 наше и своё. Если значение не совпадает, вы должны ответить кодом "1". Данный механизм предназначен для защиты значения суммы оплаты от подделки, после того, как эти параметры передаются из вашей формы в нашу платежную систему. А также для проверки, что конкретный заказ есть в вашей системе.

##### Формула рассчета MD5 на стороне Яндекс.Кассы
> md5=MD5(action;orderSumAmount;orderSumCurrencyPaycash;orderSumBankPaycash;shopId;invoiceId;customerNumber;shopPassword);

* Полученный результат переводится в верхний регистр (например, вы получите его от нас в таком виде `md5=3F4C861280B12B74D6D6BD5CE3D14680`).
* В этом подсчете важно значение `orderSumAmount`:
  * `orderSumAmount` -- это сумма платежа, которая пришла к нам из вашей формы в параметре `sum` (причем, если вы не добавили значение копеек и прислали `sum=10`, то мы будем считать в MD5 как `orderSumAmount=10.00`);
  * если у вас рублевый магазин, то `sum` пришедшее из вашей формы будет равно `orderSumAmount`, который мы передаем на ваш колбек;
  * если в поле `sum` вы передаете сумму в валюте (вы не резидент и у вас магазин типа "валюта - валюта"), например, в долларах, в этом случае мы вернем в значении `orderSumAmount = sum в используемой вами валюте`;
  * валюта по-умолчанию всегда рубли (код 643), но если у вас валютный магазин (валюта - валюта), то значение валюты, в которой мы производим расчет с вашим магазином передается вам в параметре `orderSumCurrencyPaycash` ([коды валют](https://ru.wikipedia.org/wiki/Коды_и_классификаторы_валют)).
* При подсчете MD5 значение суммы должно содержать копейки. Правильно `orderSumAmount=100.00`. НЕ правильно `orderSumAmount=100`.

##### Рекомендуемая формула рассчета MD5 на вашей стороне
> MD5(action;суммазаказа;orderSumCurrencyPaycash;orderSumBankPaycash;shopId;invoiceId;customerNumber;shopPassword);

Обратите внимание, что в вашем подсчете вы НЕ должны использовать наше значение `orderSumAmount`. Используйте то значение суммы (`суммазаказа`), которое актуально для данного заказа в вашей системе. Это позволит избежать случаев подделки суммы на этапе передачи данных из вашей формы в нашу систему. В результате:

* если сумма верна, то: MD5-ваш-с-вашей-суммой-заказа = MD5-яндекс-кассы-в-которой-суммой-заказа-мы-считаем-значение-orderSumAmount
* если сумма НЕ верна, то: MD5-ваш-с-вашей-суммой-заказа =! MD5-яндекс-кассы-в-которой-суммой-заказа-мы-считаем-значение-orderSumAmount

Дополнительно:

* [shopPassword](/demo/shopPassword-теханкета-ЛК-Кассы.png) - это пароль, который вы записали в нашей технической анкете при регистрации в Яндекс.Кассе; данный пароль является частью защитного механизма при передаче данных (это не пароль от Личного Кабинета Яндекс.Кассы и это НЕ пароль от вашего почтового ящика);
* значение shopPassword, которое мы используем при подсчете MD5, хранится у нас в настройках вашего shopId;
* длина shopPassword не может быть больше 20 символов;
* invoiceId - номер платежа в системе Яндекс.Касса (это наш основной идентификатор всех платежей; в Личном Кабинете [при просмотре списка платежей](https://yandex.ru/support/checkout/merchant/history.xml#payment-list) вы будете видеть для каждого платежа свой уникальный номер; обратите внимание, что в ЛК не отображаются демо платежи).

#### Шаг 2.2. Примеры ответов колбеков checkURL и avisoURL

Здесь описано как должны отвечать ваши скрипты checkURL и avisoURL. :paw_prints:

##### В HTTP заголовке (header) ответа должно быть:
`HTTP/1.0 200`  
`Content-Type: application/xml`
```diff
- Внимание! Любой другой код HTTP (301|302|404|403|500|503 и т.д.) не будет считаться корректным ответом
- и платеж будет завершаться ошибкой.
```

##### Формат ответа скрипта checkURL на POST-запрос action=checkOrder:
`<?xml version="1.0" encoding="UTF-8"?><checkOrderResponse performedDatetime="2011-05-04T20:38:01.000+04:00" code="0" invoiceId="2000000907465" shopId="100500"/>`

##### Формат ответа скрипта avisoURL на POST-запрос action=paymentAviso:
`<?xml version="1.0" encoding="UTF-8"?><paymentAvisoResponse performedDatetime="2011-05-04T20:38:11.000+04:00" code="0" invoiceId="2000000907465" shopId="100500"/>`

> Все параметры ответа регистрозависимы. Например, НЕ правильно `PerformedDatetime` и правильно `performedDatetime`. См. пример правильного регистра выше. Если регистр параметра указан не верно, то наша система не будет считать ответ корректным и платеж не пройдет.

##### Коды ответов
| Код         | action=checkOrder                             | action=paymentAviso                           |
| ----------- | --------------------------------------------- | --------------------------------------------- |
| `code="0"`  | такой заказ есть в магазине, можно продолжать оплату |  магазин принимает оплаченный заказ    |
| `code="1"`  | полученная MD5-сумма не совпадает с MD5-суммой на стороне магазина | тоже самое               |
| `code="100"`| такого заказа нет в магазине                                       | в авизо такого ответа нет| 
| `code="200"`| не удается выполнить разбор полученных параметров                  | тоже самое               |

##### Пример CURL

Пример CURL запроса, эмулирующий наш POST-запрос на ваш checkURL.

```bash
curl -kvd 'action=checkOrder&shopId=100500&scid=555777&customerNumber=32&cdd_pan_mask=444444|4448 \
&orderNumber=38&paymentType=AC&invoiceId=2000000833650&shopSumAmount=100.00&md5=2A409E2B81D7A77A2B745A2F62916C42 \
&orderSumAmount=3200.00&cdd_exp_date=1217&paymentPayerCode=4100322062290&cdd_rrn=&external_id=deposit \
&requestDatetime=2016-07-11T15:29:35.438+03:00&depositNumber=tNGTnJmP7sPdWnPiSeOXLUFLB5MZ.001f.201607 \
&cps_user_country_code=PL&orderCreatedDatetime=2016-07-11T15:29:35.360+03:00&sk=yed009c9df4e4f0a47d15e20d4af3231e \
&shopSumBankPaycash=1003&shopSumCurrencyPaycash=10643&rebillingOn=false&orderSumBankPaycash=1003&cps_region_id=213 \
&orderSumCurrencyPaycash=10643&merchant_order_id=38_110716152918_00000_64759 \
&unilabel=1f15a4dd-0009-5000-8000-0000116d476c&yandexPaymentId=2570052456918' https://yousite/checkURL-script.php
```

#### Шаг 2.3. Определение типа платежа, которым была произведена оплата
Если вам нужно понимать, каким методом оплачивает плательщик, обратите внимание, что в запросах checkOrder и paymentAviso мы передаем вам параметр paymentType. Например, paymentType=PC (это значит, что оплата производится через яндекс.кошелек; [список способов оплаты](https://tech.yandex.ru/money/doc/payment-solution/reference/payment-type-codes-docpage/)).

### Шаг 3. Тестирование

Вы сделали платежную форму, создали скрипты checkURL и avisoURL? Теперь можно приступить к тестированию.

* [Как выполнить тестирование оплаты](https://github.com/yandex-money/yandex-money-joinup/blob/master/demo/030%20тестирование.md)
* [Решение ошибок](https://github.com/yandex-money/yandex-money-joinup/blob/master/demo/031%20решение%20ошибок.md)
* [Демонстрационный стенд](https://github.com/yandex-money/yandex-money-joinup/blob/master/demo/032%20демо%20стенд.md)
